name: WebSocket Connection Pool Test Suite

on:
  push:
    branches: [connection-pool]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.23"

jobs:
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Build server
        run: go build -o server main.go

      - name: Build test client
        run: go build -o test-client ./cmd/tuning_client

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Run unit tests
        run: go test -v -race ./pkg/connection_pool/...

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-test
    strategy:
      matrix:
        test_case:
          - name: "åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
            pool_enabled: false
            client_count: 10
            expected_success: true
          - name: "ãƒ—ãƒ¼ãƒ«ãªã—é«˜è² è·"
            pool_enabled: false
            client_count: 50
            expected_success: true
          - name: "ãƒ—ãƒ¼ãƒ«åˆ¶é™ãƒ†ã‚¹ãƒˆ(5æ¥ç¶š)"
            pool_enabled: true
            pool_size: 5
            client_count: 20
            expected_success: true
          - name: "ãƒ—ãƒ¼ãƒ«æœ€é©åŒ–ãƒ†ã‚¹ãƒˆ(20æ¥ç¶š)"
            pool_enabled: true
            pool_size: 20
            client_count: 20
            expected_success: true
          - name: "ãƒ—ãƒ¼ãƒ«éè² è·ãƒ†ã‚¹ãƒˆ"
            pool_enabled: true
            pool_size: 5
            client_count: 100
            expected_success: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Build binaries
        run: |
          go build -o server main.go
          go build -o test-client ./cmd/tuning_client

      - name: Start server
        run: |
          ./server &
          echo $! > server.pid
          sleep 5

      - name: Run test - ${{ matrix.test_case.name }}
        env:
          USE_CONNECTION_POOL: ${{ matrix.test_case.pool_enabled }}
          POOL_SIZE: ${{ matrix.test_case.pool_size || 50 }}
          CLIENT_COUNT: ${{ matrix.test_case.client_count }}
          CHUNKS_PER_CLIENT: 15
          CHUNK_INTERVAL: 100ms
          CHUNK_SIZE: 1024
          TEST_DURATION: 10s
          CONNECT_TIMEOUT: 10s
          IDLE_TIMEOUT: 5m
        run: |
          echo "ğŸ¯ ${{ matrix.test_case.name }}"
          echo "   ãƒ—ãƒ¼ãƒ«: ${{ matrix.test_case.pool_enabled }}"
          echo "   ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º: ${{ matrix.test_case.pool_size || 'N/A' }}"
          echo "   ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ•°: ${{ matrix.test_case.client_count }}"
          
          if [ "${{ matrix.test_case.expected_success }}" = "true" ]; then
            ./test-client > test-results.log 2>&1
            if [ $? -eq 0 ]; then
              echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
              echo "ğŸ“Š çµæœ:"
              tail -10 test-results.log | grep -E "(å…¨ä½“çµ±è¨ˆ|ã‚¨ãƒ©ãƒ¼æ•°|ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ)"
            else
              echo "âŒ äºˆæœŸã—ãªã„ãƒ†ã‚¹ãƒˆå¤±æ•—"
              exit 1
            fi
          else
            ./test-client > test-results.log 2>&1 || true
            if grep -q "ã‚¨ãƒ©ãƒ¼" test-results.log; then
              echo "âœ… æœŸå¾…é€šã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ"
            else
              echo "âš ï¸  ã‚¨ãƒ©ãƒ¼ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã—ãŸãŒæˆåŠŸã—ã¾ã—ãŸ"
            fi
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.test_case.name }}-${{ matrix.test_case.client_count }}
          path: test-results.log

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: integration-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Build binaries
        run: |
          go build -o server main.go
          go build -o test-client ./cmd/tuning_client

      - name: Start server
        run: |
          ./server &
          echo $! > server.pid
          sleep 5

      - name: Performance comparison test
        run: |
          echo "ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒ†ã‚¹ãƒˆé–‹å§‹"
          
          # ãƒ—ãƒ¼ãƒ«ãªã—ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
          echo "=== ãƒ—ãƒ¼ãƒ«ãªã—ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ ==="
          USE_CONNECTION_POOL=false CLIENT_COUNT=20 ./test-client > no-pool.log 2>&1
          BASELINE_THROUGHPUT=$(grep "å…¨ä½“ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ" no-pool.log | grep -o "[0-9.]*" | head -1)
          echo "ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: ${BASELINE_THROUGHPUT} KB/s"
          
          # ãƒ—ãƒ¼ãƒ«æœ€é©åŒ–
          echo "=== ãƒ—ãƒ¼ãƒ«æœ€é©åŒ– (20æ¥ç¶š) ==="
          USE_CONNECTION_POOL=true POOL_SIZE=20 CLIENT_COUNT=20 ./test-client > pool-optimal.log 2>&1
          OPTIMAL_THROUGHPUT=$(grep "å…¨ä½“ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ" pool-optimal.log | grep -o "[0-9.]*" | head -1)
          echo "æœ€é©åŒ–: ${OPTIMAL_THROUGHPUT} KB/s"
          
          # ãƒ—ãƒ¼ãƒ«åˆ¶é™
          echo "=== ãƒ—ãƒ¼ãƒ«åˆ¶é™ (5æ¥ç¶š) ==="
          USE_CONNECTION_POOL=true POOL_SIZE=5 CLIENT_COUNT=20 ./test-client > pool-limited.log 2>&1
          LIMITED_THROUGHPUT=$(grep "å…¨ä½“ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ" pool-limited.log | grep -o "[0-9.]*" | head -1)
          echo "åˆ¶é™: ${LIMITED_THROUGHPUT} KB/s"
          
          # çµæœåˆ†æ
          echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æçµæœ:"
          echo "ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: ${BASELINE_THROUGHPUT} KB/s"
          echo "æœ€é©åŒ–: ${OPTIMAL_THROUGHPUT} KB/s"
          echo "åˆ¶é™: ${LIMITED_THROUGHPUT} KB/s"
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ãƒã‚§ãƒƒã‚¯
          if (( $(echo "${OPTIMAL_THROUGHPUT} >= ${BASELINE_THROUGHPUT} * 0.95" | awk '{print ($1 >= $2)}') )); then
            echo "âœ… æœ€é©åŒ–ãƒ—ãƒ¼ãƒ«ã¯ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®95%ä»¥ä¸Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹"
          else
            echo "âŒ æœ€é©åŒ–ãƒ—ãƒ¼ãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä¸ååˆ†"
            echo "   ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: ${BASELINE_THROUGHPUT} KB/s"
            echo "   æœ€é©åŒ–: ${OPTIMAL_THROUGHPUT} KB/s"
            exit 1
          fi

      - name: Upload performance logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-analysis
          path: "*.log"

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
